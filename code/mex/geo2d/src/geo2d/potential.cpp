/*
 * potential.cpp
 */

#include "geo2d.h"
#include "bessel.h"

double pythag(double a, double b);
double hygf(double b, double x);

double geo2d::potential(int isrc, double h, double x, double z)
/*
 * Calculates potential of a current source which is placed at the junction 
 * of four conductivity blocks at x = 0, y = 0, z = h with conductivities
 *
 * cnw: -Inf <= x <= 0,  -Inf <= y <= Inf, 0 <= z < h
 * cne:    0 <  x <= Inf,-Inf <= y <= Inf, 0 <= z < h
 * csw: -Inf <= x <= 0,  -Inf <= y <= Inf, h <= z <= Inf
 * cse:    0 <  x <= Inf,-Inf <= y <= Inf, h <= z <= Inf
 *
 */
{
  /* CONSTANTS FOR FILTER METHOD */
  /* base constant for filter abscissa generation */
  const double abscis = 0.7059431685223780;
  /* e = exp(0.1), er = 1.0/e (also used in abscissa generation) */
  const double e = 1.10517091807564762;
  const double er = 0.904837418035959573;
  /* J0 hankel transform filter weights for i = 0,...,800 */ 
  double wt0[801] = {
      2.103562053838982E-29, -1.264469361608894E-14,
      4.615731256788567E-14, -2.798703374257668E-14,
      5.465764965410841E-14, -2.652933109928729E-14,
      5.674913434067321E-14, -2.157276828977208E-14,
      5.831846086773976E-14, -1.546589284868783E-14,
      6.057302455652974E-14, -8.502531259083065E-15,
      6.388018061147645E-14, -5.659657635010288E-16,
      6.848500604791407E-14,  8.572897732168277E-15,
      7.465068154681814E-14,  1.920837293261338E-14,
      8.269345428975771E-14,  3.170116562922900E-14,
      9.300004039695208E-14,  4.649069639417992E-14,
      1.060441944490564E-13,  6.411216589597457E-14,
      1.224060834001701E-13,  8.521776751507022E-14,
      1.427957940487172E-13,  1.106026606968463E-13,
      1.680820203098405E-13,  1.412367028159546E-13,
      1.993271011776308E-13,  1.783032042964119E-13,
      2.378298196799422E-13,  2.232462602765097E-13,
      2.851776817107034E-13,  2.778285575785995E-13,
      3.433107735233557E-13,  3.442019764139949E-13,
      4.145997612327839E-13,  4.249938198224969E-13,
      5.019411631949951E-13,  5.234121310773422E-13,
      6.088737193247560E-13,  6.433743253810275E-13,
      7.397205280796933E-13,  7.896642978865920E-13,
      8.997626559623209E-13,  9.681243129571424E-13,
      1.095451187471558E-12,  1.185889375491455E-12,
      1.334666226164323E-12,  1.451673490118585E-12,
      1.627033241780647E-12,  1.776119296526221E-12,
      1.984309459865773E-12,  2.172225112712636E-12,
      2.420855801356264E-12,  2.655866524621122E-12,
      2.954213313000758E-12,  3.246433455110429E-12,
      3.605807223054322E-12,  3.967608279821300E-12,
      4.401806878720721E-12,  4.848316218220904E-12,
      5.374176077884770E-12,  5.923886142128417E-12,
      6.561955948855011E-12,  7.237468388830243E-12,
      8.012831864792648E-12,  8.841766480402105E-12,
      9.785047278800097E-12,  1.080115224902499E-11,
      1.194974128877562E-11,  1.319424925552153E-11,
      1.459380374689331E-11,  1.611708818260074E-11,
      1.782336249944076E-11,  1.968696083966218E-11,
      2.176804271234846E-11,  2.404712745375440E-11,
      2.658616922424555E-11,  2.937256616666064E-11,
      3.247112071587450E-11,  3.587699548548411E-11,
      3.965909071112399E-11,  4.382145152220635E-11,
      4.843856688602439E-11,  5.352476425684008E-11,
      5.916190912377549E-11,  6.537635327328955E-11,
      7.225949098391667E-11,  7.985185650562155E-11,
      8.825697213255412E-11,  9.753221923111176E-11,
      1.077963949370144E-10,  1.191270094182892E-10,
      1.316619519054340E-10,  1.455028951566729E-10,
      1.608114581091983E-10,  1.777184270673645E-10,
      1.964147916871289E-10,  2.170665216346822E-10,
      2.399008451839042E-10,  2.651263504640323E-10,
      2.930148720448538E-10,  3.238267179640594E-10,
      3.578885297833856E-10,  3.955234710219298E-10,
      4.371254308993604E-10,  4.830940473937580E-10,
      5.339056350072159E-10,  5.900529573690070E-10,
      6.521132758098962E-10,  7.206928333934838E-10,
      7.964924450372341E-10,  8.802567084675067E-10,
      9.728375895186283E-10,  1.075148437456224E-09,
      1.188226062693121E-09,  1.313189706258061E-09,
      1.451302163665563E-09,  1.603933943511600E-09,
      1.772624063293560E-09,  1.959049733219870E-09,
      2.165087540667258E-09,  2.392789115986871E-09,
      2.644443536014764E-09,  2.922559573439235E-09,
      3.229930291248597E-09,  3.569622651576204E-09,
      3.945045448172924E-09,  4.359947261255963E-09,
      4.818489091363688E-09,  5.325251901762953E-09,
      5.885315583343685E-09,  6.504277635547376E-09,
      7.188340419242570E-09,  7.944342903082902E-09,
      8.779858562959109E-09,  9.703242578022093E-09,
      1.072374322768940E-08,  1.185156747840095E-08,
      1.309800933225301E-08,  1.447553742402158E-08,
      1.599794451372024E-08,  1.768046154055318E-08,
      1.953993335487118E-08,  2.159496468450500E-08,
      2.386612830616206E-08,  2.637614961034523E-08,
      2.915015476269831E-08,  3.221590205565798E-08,
      3.560407926098509E-08,  3.934859178954436E-08,
      4.348692045365787E-08,  4.806047869438007E-08,
      5.311504443749314E-08,  5.870120138001748E-08,
      6.487486163571268E-08,  7.169780940885934E-08,
      7.923833480505012E-08,  8.757190229426675E-08,
      9.678192055835553E-08,  1.069605631204864E-07,
      1.182097045925483E-07,  1.306419269237675E-07,
      1.443816591198488E-07,  1.595664099835792E-07,
      1.763481565722233E-07,  1.948948533650376E-07,
      2.153921247351847E-07,  2.380451115468297E-07,
      2.630805351444854E-07,  2.907489558998551E-07,
      3.213272911558462E-07,  3.551215767529809E-07,
      3.924700396067688E-07,  4.337464734078393E-07,
      4.793639887921159E-07,  5.297791390370199E-07,
      5.854964979982190E-07,  6.470737017046583E-07,
      7.151270374758372E-07,  7.903376040582035E-07,
      8.734581359370587E-07,  9.653205295304359E-07,
      1.066844176299330E-06,  1.179045157323447E-06,
      1.303046419382764E-06,  1.440089007182073E-06,
      1.591544490556806E-06,  1.758928685376697E-06,
      1.943916830388476E-06,  2.148360347694608E-06,
      2.374305378111399E-06,  2.624013254094558E-06,
      2.899983137292810E-06,  3.204977025773239E-06,
      3.542047402097807E-06,  3.914567778667102E-06,
      4.326266465748067E-06,  4.781263881007758E-06,
      5.284113792545945E-06,  5.839848890150422E-06,
      6.454031158395685E-06,  7.132807538712648E-06,
      7.882971454044484E-06,  8.712030795792633E-06,
      9.628283069078871E-06,  1.064089843325841E-05,
      1.176001148348469E-05,  1.299682267761921E-05,
      1.436371043746991E-05,  1.587435503282041E-05,
      1.754387550120777E-05,  1.938898096105121E-05,
      2.142813784487508E-05,  2.368175471430264E-05,
      2.617238651818130E-05,  2.892496032668667E-05,
      3.196702481167932E-05,  3.532902595927333E-05,
      3.904461178455365E-05,  4.315096908756330E-05,
      4.768919563102351E-05,  5.270471145419851E-05,
      5.824771344935570E-05,  6.437367773954276E-05,
      7.114391489568718E-05,  7.862618353777022E-05,
      8.689536847209423E-05,  9.603423013681158E-05,
      1.061342328695059E-04,  1.172964602657162E-04,
      1.296326268075215E-04,  1.432661958546299E-04,
      1.583336152150400E-04,  1.749856826064412E-04,
      1.933890547221590E-04,  2.137279149064782E-04,
      2.362058162174614E-04,  2.610477181410775E-04,
      2.885022375064333E-04,  3.188441357870562E-04,
      3.523770680013592E-04,  3.894366200728159E-04,
      4.303936656695837E-04,  4.756580748770003E-04,
      5.256828130316798E-04,  5.809684683619367E-04,
      6.420682561143772E-04,  7.095935446942389E-04,
      7.842199637491256E-04,  8.666941465924691E-04,
      9.578411834759010E-04,  1.058572843543458E-03,
      1.169896665384001E-03,  1.292925974983324E-03,
      1.428890965739396E-03,  1.579150889627630E-03,
      1.745207548623177E-03,  1.928720102656342E-03,
      2.131521473093367E-03,  2.355636277673631E-03,
      2.603300731229735E-03,  2.876984272542283E-03,
      3.179413630050106E-03,  3.513598723334281E-03,
      3.882861625673649E-03,  4.290867254031690E-03,
      4.741657973486860E-03,  5.239689338467119E-03,
      5.789870985188969E-03,  6.397607072000340E-03,
      7.068843783102744E-03,  7.810112796625723E-03,
      8.628584975720666E-03,  9.532112534855741E-03,
      1.052928697105230E-02,  1.162947042684567E-02,
      1.284285301027502E-02,  1.418045400408490E-02,
      1.565416842684913E-02,  1.727670025860997E-02,
      1.906157878467033E-02,  2.102295173845023E-02,
      2.317553622087861E-02,  2.553413681316817E-02,
      2.811347056705691E-02,  3.092716134472897E-02,
      3.398734108220733E-02,  3.730266904318316E-02,
      4.087756584601726E-02,  4.470845458227711E-02,
      4.878245655564208E-02,  5.307046388837388E-02,
      5.752521479656082E-02,  6.206888924914453E-02,
      6.659098690582325E-02,  7.092687097703928E-02,
      7.485762155329997E-02,  7.807466421172765E-02,
      8.018887211338042E-02,  8.067640670918657E-02,
      7.891767306422777E-02,  7.412406301630496E-02,
      6.545864753141331E-02,  5.195771725733346E-02,
      3.284797274184859E-02,  7.497076325831270E-03,
     -2.386612869894549E-02, -6.017494378476118E-02,
     -9.817899798850670E-02, -1.328147797272611E-01,
     -1.554628569772562E-01, -1.563982157987450E-01,
     -1.243049866529050E-01, -5.486815986343697E-02,
      4.686255899170307E-02,  1.511218295806206E-01,
      2.119315534410599E-01,  1.695134135887796E-01,
      1.386197420331480E-02, -1.869350451838135E-01,
     -2.455889606925336E-01, -5.309269401899814E-02,
      2.519998415798595E-01,  1.968224876057428E-01,
     -2.014333618969160E-01, -2.458450827258603E-01,
      3.433559314076636E-01, -4.770066510626292E-02,
     -2.096628473507452E-01,  2.509085123794248E-01,
     -1.676412661335192E-01,  7.495199786896762E-02,
     -1.695135102751146E-02, -8.828524201374996E-03,
      1.616787356183550E-02, -1.556411755992529E-02,
      1.251311125216370E-02, -9.299315246978098E-03,
      6.650525996779493E-03, -4.667707408671884E-03,
      3.248885545556855E-03, -2.255529108544675E-03,
      1.566875211100915E-03, -1.091132486368091E-03,
      7.625383049040949E-04, -5.352540577820408E-04,
      3.777104567214670E-04, -2.682528211535297E-04,
      1.920265274996755E-04, -1.388213723208944E-04,
      1.015998917810005E-04, -7.549725062631259E-05,
      5.714172920052936E-05, -4.419160967680634E-05,
      3.501776199578583E-05, -2.848496954139990E-05,
      2.380104817324115E-05, -2.041274924032166E-05,
      1.793363489791860E-05, -1.609367780777977E-05,
      1.470394692017765E-05, -1.363208540087839E-05,
      1.278540851480116E-05, -1.209910323276592E-05,
      1.152780746372085E-05, -1.103964249967709E-05,
      1.061214724478712E-05, -1.022954672255804E-05,
      9.880801917269063E-06, -9.558136268373164E-06,
      9.255989462874843E-06, -8.970368039834961E-06,
      8.698439226217636E-06, -8.438199899378174E-06,
      8.188185039708096E-06, -7.947275976752668E-06,
      7.714620489277084E-06, -7.489590334670121E-06,
      7.271712845563131E-06, -7.060595202720040E-06,
      6.855890958634290E-06, -6.657307826365352E-06,
      6.464610635947412E-06, -6.277596705248834E-06,
      6.096069004564178E-06, -5.919835014912806E-06,
      5.748721389173238E-06, -5.582576428368341E-06,
      5.421255729073172E-06, -5.264611483233620E-06,
      5.112497827757443E-06, -4.964780650195476E-06,
      4.821336526159266E-06, -4.682043530422997E-06,
      4.546777587820041E-06, -4.415418000076004E-06,
      4.287852503112911E-06, -4.163974668109847E-06,
      4.043678407829827E-06, -3.926857526517075E-06,
      3.813409851360361E-06, -3.703239239834851E-06,
      3.596252927182967E-06, -3.492358600906126E-06,
      3.391465179914198E-06, -3.293485431241940E-06,
      3.198336356446399E-06, -3.105937110348406E-06,
      3.016207679069661E-06, -2.929069911562291E-06,
      2.844448954094881E-06, -2.762272935820411E-06,
      2.682471568415877E-06, -2.604975709140556E-06,
      2.529718233664062E-06, -2.456634690985054E-06,
      2.385662793855871E-06, -2.316741584624232E-06,
      2.249811415880699E-06, -2.184814552602377E-06,
      2.121695378987067E-06, -2.060399926949900E-06,
      2.000875435893980E-06, -1.943070483347481E-06,
      1.886935339579619E-06, -1.832421953831803E-06,
      1.779483599068986E-06, -1.728074671861562E-06,
      1.678150840818710E-06, -1.629669220867866E-06,
      1.582588274939725E-06, -1.536867577717458E-06,
      1.492467744182388E-06, -1.449350544031671E-06,
      1.407478963215944E-06, -1.366817091697906E-06,
      1.327329980403758E-06, -1.288983628354532E-06,
      1.251745052743577E-06, -1.215582289623042E-06,
      1.180464297731392E-06, -1.146360878232118E-06,
      1.113242681755176E-06, -1.081081241360643E-06,
      1.049848946307979E-06, -1.019518969919736E-06,
      9.900652269648073E-07, -9.614623823829486E-07,
      9.336858590396268E-07, -9.067118039187765E-07,
      8.805170379415897E-07, -8.550790335506564E-07,
      8.303759185665738E-07, -8.063864695073603E-07,
      7.830900795968434E-07, -7.604667251660013E-07,
      7.384969528074763E-07, -7.171618775580271E-07,
      6.964431695613518E-07, -6.763230273695452E-07,
      6.567841555251206E-07, -6.378097555683096E-07,
      6.193835199757372E-07, -6.014896169720738E-07,
      5.841126695566173E-07, -5.672377400509635E-07,
      5.508503223216395E-07, -5.349363333399711E-07,
      5.194820986824491E-07, -5.044743364413132E-07,
      4.899001458890472E-07, -4.757469999761242E-07,
      4.620027360551677E-07, -4.486555431391317E-07,
      4.356939495368206E-07, -4.231068139067277E-07,
      4.108833178901058E-07, -3.990129570237777E-07,
      3.874855299952715E-07, -3.762911289578004E-07,
      3.654201320223786E-07, -3.548631961765860E-07,
      3.446112489455190E-07, -3.346554794873414E-07,
      3.249873307934947E-07, -3.155984931421240E-07,
      3.064808974928670E-07, -2.976267081233949E-07,
      2.890283152696976E-07, -2.806783286653362E-07,
      2.725695717362821E-07, -2.646950756050221E-07,
      2.570480727284082E-07, -2.496219907786807E-07,
      2.424104471687142E-07, -2.354072438896643E-07,
      2.286063621819694E-07, -2.220019570969968E-07,
      2.155883523600859E-07, -2.093600356601861E-07,
      2.033116540781646E-07, -1.974380094205501E-07,
      1.917340535876188E-07, -1.861948842172547E-07,
      1.808157405985162E-07, -1.755919996494557E-07,
      1.705191718700136E-07, -1.655928973946416E-07,
      1.608089422670497E-07, -1.561631948835526E-07,
      1.516516624771349E-07, -1.472704676262496E-07,
      1.430158448819191E-07, -1.388841375627619E-07,
      1.348717946589134E-07, -1.309753677747614E-07,
      1.271915081246862E-07, -1.235169636417206E-07,
      1.199485762099940E-07, -1.164832789732080E-07,
      1.131180936862105E-07, -1.098501281312535E-07,
      1.066765736321394E-07, -1.035947026599537E-07,
      1.006018664975167E-07, -9.769549295058651E-08,
      9.487308412474974E-08, -9.213221428331440E-08,
      8.947052777472484E-08, -8.688573700943115E-08,
      8.437562048443172E-08, -8.193802086874367E-08,
      7.957084315467929E-08, -7.727205286392824E-08,
      7.503967429747869E-08, -7.287178883148888E-08,
      7.076653326692979E-08, -6.872209823264986E-08,
      6.673672663335082E-08, -6.480871213716780E-08,
      6.293639770567428E-08, -6.111817417008917E-08,
      5.935247885127626E-08, -5.763779421770836E-08,
      5.597264657919956E-08, -5.435560481863042E-08,
      5.278527916288309E-08, -5.126031999018991E-08,
      4.977941667022704E-08, -4.834129643623350E-08,
      4.694472329047102E-08, -4.558849694284832E-08,
      4.427145178025873E-08, -4.299245586445184E-08,
      4.175040995827635E-08, -4.054424658081963E-08,
      3.937292909065092E-08, -3.823545079527342E-08,
      3.713083408552377E-08, -3.605812959486601E-08,
      3.501641538356351E-08, -3.400479614676831E-08,
      3.302240244515663E-08, -3.206838995736202E-08,
      3.114193875409117E-08, -3.024225259359901E-08,
      2.936855823761587E-08, -2.852010478676213E-08,
      2.769616303496246E-08, -2.689602484264953E-08,
      2.611900252829978E-08, -2.536442827753140E-08,
      2.463165356908288E-08, -2.392004861730570E-08,
      2.322900183088905E-08, -2.255791928733344E-08,
      2.190622422255186E-08, -2.127335653510145E-08,
      2.065877230473273E-08, -2.006194332493974E-08,
      1.948235664905881E-08, -1.891951414942437E-08,
      1.837293208920017E-08, -1.784214070660012E-08,
      1.732668381117887E-08, -1.682611839179446E-08,
      1.634001423585344E-08, -1.586795355952947E-08,
      1.540953064868929E-08, -1.496435151022419E-08,
      1.453203353344868E-08, -1.411220516125227E-08,
      1.370450557074419E-08, -1.330858436314438E-08,
      1.292410126264865E-08, -1.255072582398340E-08,
      1.218813714839246E-08, -1.183602360782992E-08,
      1.149408257713515E-08, -1.116202017395058E-08,
      1.083955100614394E-08, -1.052639792651900E-08,
      1.022229179461678E-08, -9.926971245406734E-09,
      9.640182464660921E-09, -9.361678970810806E-09,
      9.091221403102823E-09, -8.828577315878212E-09,
      8.573520978800615E-09, -8.325833182853652E-09,
      8.085301051938885E-09, -7.851717859915976E-09,
      7.624882852931747E-09, -7.404601076884107E-09,
      7.190683209868762E-09, -6.982945399464102E-09,
      6.781209104717332E-09, -6.585300942697731E-09,
      6.395052539483568E-09, -6.210300385452473E-09,
      6.030885694751333E-09, -5.856654268826800E-09,
      5.687456363899640E-09, -5.523146562267662E-09,
      5.363583647325650E-09, -5.208630482195534E-09,
      5.058153891863612E-09, -4.912024548723426E-09,
      4.770116861425010E-09, -4.632308866934630E-09,
      4.498482125712853E-09, -4.368521619921419E-09,
      4.242315654571151E-09, -4.119755761525383E-09,
      4.000736606276379E-09, -3.885155897415073E-09,
      3.772914298716528E-09, -3.663915343765296E-09,
      3.558065353046999E-09, -3.455273353434971E-09,
      3.355451000003056E-09, -3.258512500097394E-09,
      3.164374539601736E-09, -3.072956211332787E-09,
      2.984178945504153E-09, -2.897966442199276E-09,
      2.814244605795313E-09, -2.732941481281439E-09,
      2.653987192416816E-09, -2.577313881675167E-09,
      2.502855651924429E-09, -2.430548509791296E-09,
      2.360330310661908E-09, -2.292140705271406E-09,
      2.225921087836540E-09, -2.161614545686758E-09,
      2.099165810350450E-09, -2.038521210054267E-09,
      1.979628623594711E-09, -1.922437435542387E-09,
      1.866898492740427E-09, -1.812964062059653E-09,
      1.760587789374176E-09, -1.709724659722168E-09,
      1.660330958617607E-09, -1.612364234479730E-09,
      1.565783262147887E-09, -1.520548007450427E-09,
      1.476619592797189E-09, -1.433960263766035E-09,
      1.392533356654690E-09, -1.352303266970005E-09,
      1.313235418827548E-09, -1.275296235235242E-09,
      1.238453109235514E-09, -1.202674375881138E-09,
      1.167929285020692E-09, -1.134187974870230E-09,
      1.101421446348478E-09, -1.069601538153474E-09,
      1.038700902559248E-09, -1.008692981911727E-09,
      9.795519858036667E-10, -9.512528689090021E-10,
      9.237713094575600E-10, -8.970836883316330E-10,
      8.711670687664494E-10, -8.459991766370928E-10,
      8.215583813149323E-10, -7.978236770771082E-10,
      7.747746650530930E-10, -7.523915356928136E-10,
      7.306550517412669E-10, -7.095465317049981E-10,
      6.890478337962292E-10, -6.691413403408390E-10,
      6.498099426367938E-10, -6.310370262500165E-10,
      6.128064567350563E-10, -5.951025657682865E-10,
      5.779101376817111E-10, -5.612143963858077E-10,
      5.450009926701687E-10, -5.292559918710250E-10,
      5.139658618950525E-10, -4.991174615891697E-10,
      4.846980294463296E-10, -4.706951726376001E-10,
      4.570968563611062E-10, -4.438913934986793E-10,
      4.310674345713248E-10, -4.186139579848742E-10,
      4.065202605574395E-10, -3.947759483205284E-10,
      3.833709275859127E-10, -3.722953962705749E-10,
      3.615398354722752E-10, -3.510950012884991E-10,
      3.409519168717552E-10, -3.311018647143929E-10,
      3.215363791563124E-10, -3.122472391091240E-10,
      3.032264609905071E-10, -2.944662918626933E-10,
      2.859592027691788E-10, -2.776978822639370E-10,
      2.696752301275724E-10, -2.618843512650130E-10,
      2.543185497794985E-10, -2.469713232177689E-10,
      2.398363569815098E-10, -2.329075189002498E-10,
      2.261788539610461E-10, -2.196445791904288E-10,
      2.132990786842053E-10, -2.071368987808525E-10,
      2.011527433743496E-10, -1.953414693624216E-10,
      1.896980822262837E-10, -1.842177317380848E-10,
      1.788957077923634E-10, -1.737274363579317E-10,
      1.687084755467094E-10, -1.638345117961281E-10,
      1.591013561618254E-10, -1.545049407174433E-10,
      1.500413150584345E-10, -1.457066429068751E-10,
      1.414971988143619E-10, -1.374093649601637E-10,
      1.334396280418735E-10, -1.295845762558885E-10,
      1.258408963651246E-10, -1.222053708514437E-10,
      1.186748751503467E-10, -1.152463749655566E-10,
      1.119169236611821E-10, -1.086836597292220E-10,
      1.055438043302322E-10, -1.024946589050432E-10,
      9.953360285547502E-11, -9.665809129205519E-11,
      9.386565284680683E-11, -9.115388754922578E-11,
      8.852046476362457E-11, -8.596312118607507E-11,
      8.347965889923978E-11, -8.106794348344660E-11,
      7.872590218244558E-11, -7.645152212241484E-11,
      7.424284858301879E-11, -7.209798331980772E-11,
      7.001508293831718E-11, -6.799235732265070E-11,
      6.602806812690510E-11, -6.412052735069306E-11,
      6.226809604991307E-11, -6.046918330329692E-11,
      5.872224571634798E-11, -5.702578811834639E-11,
      5.537836697680089E-11, -5.377860007122251E-11,
      5.222519065363231E-11, -5.071698520520750E-11,
      4.925310917157278E-11, -4.783328375532226E-11,
      4.645856316442775E-11, -4.513304831495452E-11,
      4.386786828115582E-11, -4.269042848860555E-11,
      4.166589074066043E-11, -4.094706131972530E-11,
      4.089025606285087E-11, -4.232439520086882E-11,
      4.717597028661840E-11, -5.992051472297203E-11,
      9.095360729014628E-11};
  /* precision for cutoff at tails */
  const double tol = 1.0e-16;
      
  /* variable declarations */
  double s1, s2, k, phi, c, cmax, t, t0;
  int i;
  bool none = 0;
  
  if (z == h && x == 0.0)
  {
    return(HUGE_VAL);
  }
  
  s1 = cback[isrc][0] + cback[isrc][1];
  s2 = cback[isrc][2] + cback[isrc][3];
  k = (s1 - s2) / (s1 + s2);

  if (h == 0.0)
  /* surface source */
  {
    phi = 1.0 / pythag(x,z);
  }
  else
  /* buried source */
  {
    
    if (k == 0.0)
    /* Vertical contact or homogeneous halfspace */
    {
      phi = 1.0 / pythag(x,z-h) + 1.0 / pythag(x,z+h);
    }
    else
    /* Mirror sources due to horizontal conductivity contrast */
    {
      x = fabs(x);
      if (x > 0.0)
      /* Apply filter method */
      {
        phi = 0.0;
        t0 = abscis / x;
        t = t0;
        cmax = 0.0;
        /* convolution of fixed center part */
        for (i = 298; i < 339; i++)
        {
          t *= e;
          c = (exp(-(z+h)*t) + exp(-fabs(z-h)*t)) / (1.0 - k * exp(-2.0*h*t))
            * wt0[i];
          phi += c;
          cmax = max(cmax,fabs(c));
        }
        if (cmax == 0.0) none = 1;
        cmax *= tol;
        /* right tail */
        t *= e;
        c = (exp(-(z+h)*t) + exp(-fabs(z-h)*t)) / (1.0 - k * exp(-2.0*h*t))
          * wt0[339];
        phi += c;
        for (i = 340; i < 801 && fabs(c) > cmax; i++)
        {
          t *= e;
          c = (exp(-(z+h)*t) + exp(-fabs(z-h)*t)) / (1.0 - k * exp(-2.0*h*t))
            * wt0[i];
          phi += c;
        }
        /* left tail */
        t = t0;
        c = (exp(-(z+h)*t) + exp(-fabs(z-h)*t)) / (1.0 - k * exp(-2.0*h*t))
          * wt0[297];
        phi += c;
        for (i = 296; i >= 0 && (fabs(c) > cmax || none); i--)
        {
          t *= er;
          c = (exp(-(z+h)*t) + exp(-fabs(z-h)*t)) / (1.0 - k * exp(-2.0*h*t))
            * wt0[i];
          phi += c;
        }
        phi /= x;
      }
      else
      /* Use closed formula for x == 0, involving the hypergeometric function */
      {
        phi = hygf(fabs(z - h) / (2.0 * h), k) / fabs(z - h)
          + hygf((z + h) / (2.0 * h), k) / (z + h);
      }
    }
  }
  return(phi / (M_PI * (s1 + s2)));
}

double geo2d::potential(int isrc, double h, double x, double z, double lambda)
/*
 * Calculates potential in the wavenumber domain with wavenumber lambda being 
 * the transform variable of y. The current source is placed at the junction 
 * of four conductivity blocks at x = 0, y = 0, z = h with conductivities
 *
 * cnw: -Inf <= x <= 0,  -Inf <= y <= Inf, 0 <= z < h
 * cne:    0 <  x <= Inf,-Inf <= y <= Inf, 0 <= z < h
 * csw: -Inf <= x <= 0,  -Inf <= y <= Inf, h <= z <= Inf
 * cse:    0 <  x <= Inf,-Inf <= y <= Inf, h <= z <= Inf
 *
 * Summation quits if relative change in potential is less than eps or if
 * maximum number of steps are reached.
 */
{
  double z1, z2, s1, s2, k, kn, phi, phii, eps;
  int i, imax;

  /* Constants for summation of series */
  imax = 1000;  /* worst case requires 1.0e008 */
  eps = 1.0e-8; /* iterations for eps = 1.0e-8 */
  
  if ((x == 0.0 && z == h) || lambda <= 0.0) // source location
  {
    return(0.0);  // Can't continue computing with 'Infinity'
  }
  
  s1 = cback[isrc][0] + cback[isrc][1];
  s2 = cback[isrc][2] + cback[isrc][3];
  k = (s1 - s2) / (s1 + s2);

  if (h == 0.0)
  {
    /* surface source */
    phi = bessk0(lambda * pythag(z,x));
  }
  else
  {
    /* buried source */
    if (k == 0.0)
    {
      phi = bessk0(lambda * pythag(z-h,x)) + bessk0(lambda * pythag(z+h,x));
    }
    else
    {
      z1 = z - h;
      z2 = z + h;
      phi = bessk0(lambda * pythag(z1,x));
      if (phi > 0.0) // continue only if phi is still a machine number
      {
        if (z < h) // first layer
        {
          h *= 2.0;
          kn = 1.0;
          phi += bessk0(lambda * pythag(z2,x));
          phii = phi;
          for (i = 0; i < imax; i++)
          {
            z1 -= h;
            z2 += h;
            kn *= k;
            phii = kn * (bessk0(lambda * pythag(z1,x))
              + bessk0(lambda * pythag(z2,x)));
            phi += phii;
            if (fabs(phii) <= eps * fabs(phi)) break;
          }
        }
        else // second layer
        {
          h *= 2.0;
          kn = 1.0 + k;
          phi += kn * bessk0(lambda * pythag(z2,x));
          phii = phi;
          for (i = 0; i < imax; i++)
          {
            z2 += h;
            kn *= k;
            phii = kn * bessk0(lambda * pythag(z2,x));
            phi += phii;
            if (fabs(phii) <= eps * fabs(phi)) break;
          }
        }
      }
    }
  }
  return( phi / (M_PI * (s1 + s2)) );
}

double geo2d::dpotdx(int isrc, double h, double x, double z, double lambda)
/*
 * Calculates first derivativ of potential with respect to x
 * in the wavenumber domain with wavenumber lambda being 
 * the transform variable of y. The current source is placed at the junction 
 * of four conductivity blocks at x = 0, y = 0, z = h with conductivities
 *
 * cnw: -Inf <= x <= 0,  -Inf <= y <= Inf, 0 <= z < h
 * cne:    0 <  x <= Inf,-Inf <= y <= Inf, 0 <= z < h
 * csw: -Inf <= x <= 0,  -Inf <= y <= Inf, h <= z <= Inf
 * cse:    0 <  x <= Inf,-Inf <= y <= Inf, h <= z <= Inf
 *
 * Summation quits if relative change in potential is less than eps or if
 * maximum number of steps are reached.
 */
{
  double z1, z2, r1, r2, s1, s2, k, kn, phi, phii, eps;
  int i, imax;

  /* Constants for summation of series */
  imax = 1000;  /* worst case requires 1.0e008 */
  eps = 1.0e-8; /* iterations for eps = 1.0e-8 */
  
  if ((x == 0.0 && z == h) || lambda <= 0.0) // source location
  {
    return(0.0);  // Can't continue computing with 'Infinity'
  }
  
  s1 = cback[isrc][0] + cback[isrc][1];
  s2 = cback[isrc][2] + cback[isrc][3];
  k = (s1 - s2) / (s1 + s2);

  if (h == 0.0)
  {
    /* surface source */
    r1 = pythag(z,x);
    phi = bessk1(lambda * r1) * x / r1;
  }
  else
  {
    /* buried source */
    if (k == 0.0)
    {
      r1 = pythag(z-h,x);
      r2 = pythag(z+h,x);
      phi = x * (bessk1(lambda * r1) / r1 + bessk1(lambda * r2) / r2);
    }
    else
    {
      z1 = z - h;
      z2 = z + h;
      r1 = pythag(z1,x);
      phi = bessk1(lambda * r1) * x / r1;
      if (phi > 0.0) // continue only if phi is still a machine number
      {
        if (z < h) // first layer
        {
          h *= 2.0;
          kn = 1.0;
          r2 = pythag(z2,x);
          phi += bessk1(lambda * r2) * x / r2;
          phii = phi;
          for (i = 0; i < imax; i++)
          {
            z1 -= h;
            z2 += h;
            r1 = pythag(z1,x);
            r2 = pythag(z2,x);
            kn *= k;
            phii = kn * x * (bessk1(lambda * r1) / r1
              + bessk1(lambda * r2) / r2);
            phi += phii;
            if (fabs(phii) <= eps * fabs(phi)) break;
          }
        }
        else // second layer
        {
          h *= 2.0;
          kn = 1.0 + k;
          r2 = pythag(z2,x);
          phi += kn * bessk1(lambda * r2) * x / r2;
          phii = phi;
          for (i = 0; i < imax; i++)
          {
            z2 += h;
            r2 = pythag(z2,x);
            kn *= k;
            phii = kn * bessk1(lambda * r2) * x / r2;
            phi += phii;
            if (fabs(phii) <= eps * fabs(phi)) break;
          }
        }
      }
    }
  }
  return( -lambda * phi / (M_PI * (s1 + s2)) );
}

double geo2d::dpotdz(int isrc, double h, double x, double z, double lambda)
/*
 * Calculates first derivativ of potential with respect to z
 * in the wavenumber domain with wavenumber lambda being 
 * the transform variable of y. The current source is placed at the junction 
 * of four conductivity blocks at x = 0, y = 0, z = h with conductivities
 *
 * cnw: -Inf <= x <= 0,  -Inf <= y <= Inf, 0 <= z < h
 * cne:    0 <  x <= Inf,-Inf <= y <= Inf, 0 <= z < h
 * csw: -Inf <= x <= 0,  -Inf <= y <= Inf, h <= z <= Inf
 * cse:    0 <  x <= Inf,-Inf <= y <= Inf, h <= z <= Inf
 *
 * Summation quits if relative change in potential is less than eps or if
 * maximum number of steps are reached.
 */
{
  double z1, z2, r1, r2, s1, s2, k, kn, phi, phii, eps;
  int i, imax;

  /* Constants for summation of series */
  imax = 1000;  /* worst case requires 1.0e008 */
  eps = 1.0e-8; /* iterations for eps = 1.0e-8 */
  
  if ((x == 0.0 && z == h) || lambda <= 0.0) // source location
  {
    return(0.0);  // Can't continue computing with 'Infinity'
  }
  
  s1 = cback[isrc][0] + cback[isrc][1];
  s2 = cback[isrc][2] + cback[isrc][3];
  k = (s1 - s2) / (s1 + s2);

  if (h == 0.0)
  {
    /* surface source */
    r1 = pythag(z,x);
    phi = bessk1(lambda * r1) * z / r1;
  }
  else
  {
    /* buried source */
    if (k == 0.0)
    {
      z1 = z - h;
      z2 = z + h;
      r1 = pythag(z1,x);
      r2 = pythag(z2,x);
      phi = bessk1(lambda * r1) * z1 / r1 + bessk1(lambda * r2) * z2 / r2;
    }
    else
    {
      z1 = z - h;
      z2 = z + h;
      r1 = pythag(z1,x);
      phi = bessk1(lambda * r1) * z1 / r1;
      if (phi > 0.0) // continue only if phi is still a machine number
      {
        if (z < h) // first layer
        {
          h *= 2.0;
          kn = 1.0;
          r2 = pythag(z2,x);
          phi += bessk1(lambda * r2) * z2 / r2;
          phii = phi;
          for (i = 0; i < imax; i++)
          {
            z1 -= h;
            z2 += h;
            r1 = pythag(z1,x);
            r2 = pythag(z2,x);
            kn *= k;
            phii = kn * (bessk1(lambda * r1) * z1 / r1
              + bessk1(lambda * r2) * z2 / r2);
            phi += phii;
            if (fabs(phii) <= eps * fabs(phi)) break;
          }
        }
        else // second layer
        {
          h *= 2.0;
          kn = 1.0 + k;
          r2 = pythag(z2,x);
          phi += kn * bessk1(lambda * r2) * z2 / r2;
          phii = phi;
          for (i = 0; i < imax; i++)
          {
            z2 += h;
            r2 = pythag(z2,x);
            kn *= k;
            phii = kn * bessk1(lambda * r2) * z2 / r2;
            phi += phii;
            if (fabs(phii) <= eps * fabs(phi)) break;
          }
        }
      }
    }
  }
  return( -lambda * phi / (M_PI * (s1 + s2)) );
}

